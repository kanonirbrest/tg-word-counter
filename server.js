const express = require('express');
const { Telegraf } = require('telegraf');
require('dotenv').config();

const app = express();
const bot = new Telegraf(process.env.BOT_TOKEN);

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ð° Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ ÑÐ»Ð¾Ð²
function getWordFrequency(text) {
  try {
    // ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ñ‚ÐµÐºÑÑ‚ Ðº Ð½Ð¸Ð¶Ð½ÐµÐ¼Ñƒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ñƒ Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° ÑÐ»Ð¾Ð²Ð°
    const words = text.toLowerCase()
      .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '') // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹
      .split(/\s+/)
      .filter(word => word.length > 2); // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ»Ð¾Ð²Ð° ÐºÐ¾Ñ€Ð¾Ñ‡Ðµ 3 Ð±ÑƒÐºÐ²

    // ÐŸÐ¾Ð´ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñƒ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°
    const frequency = {};
    words.forEach(word => {
      frequency[word] = (frequency[word] || 0) + 1;
    });

    // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ»Ð¾Ð²Ð° Ð¿Ð¾ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ðµ
    const sortedWords = Object.entries(frequency)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 15); // Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð¿-15

    return { success: true, data: sortedWords };
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ðµ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ ÑÐ»Ð¾Ð²:', error);
    return { success: false, error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚' };
  }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸Ð· Ñ‡Ð°Ñ‚Ð° Ð·Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´
async function getChatMessages(ctx, period) {
  try {
    const chatId = ctx.chat.id;
    const now = Date.now();
    let startTime;
    
    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÐµÑ€Ð¸Ð¾Ð´
    switch(period) {
      case 'day':
        startTime = now - 24 * 60 * 60 * 1000; // 24 Ñ‡Ð°ÑÐ°
        break;
      case 'week':
        startTime = now - 7 * 24 * 60 * 60 * 1000; // 7 Ð´Ð½ÐµÐ¹
        break;
      case 'month':
        startTime = now - 30 * 24 * 60 * 60 * 1000; // 30 Ð´Ð½ÐµÐ¹
        break;
      default:
        throw new Error('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´');
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°
    const messages = await ctx.telegram.getChatHistory(chatId, {
      limit: 100, // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
      offset: 0
    });

    // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
    const filteredMessages = messages.filter(msg => {
      const msgDate = msg.date * 1000; // ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´Ñ‹
      return msgDate >= startTime && msgDate <= now;
    });

    // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    const text = filteredMessages
      .map(msg => msg.text || '')
      .filter(text => text.length > 0)
      .join(' ');

    return { success: true, data: text };
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:', error);
    return { 
      success: false, 
      error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð±Ð¾Ñ‚ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ñ‡Ð°Ñ‚Ð°.'
    };
  }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° inline Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
bot.on('inline_query', async (ctx) => {
  const query = ctx.inlineQuery.query;
  
  if (query) {
    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
    let period;
    if (query.includes('Ð´ÐµÐ½ÑŒ') || query.includes('Ð´Ð½Ñ')) {
      period = 'day';
    } else if (query.includes('Ð½ÐµÐ´ÐµÐ»Ñ') || query.includes('Ð½ÐµÐ´ÐµÐ»ÑŽ')) {
      period = 'week';
    } else if (query.includes('Ð¼ÐµÑÑÑ†') || query.includes('Ð¼ÐµÑÑÑ†Ð°')) {
      period = 'month';
    } else {
      period = 'day'; // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð° Ð´ÐµÐ½ÑŒ
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°
    const messagesResult = await getChatMessages(ctx, period);
    
    if (messagesResult.success) {
      // ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚
      const result = getWordFrequency(messagesResult.data);
      
      if (result.success) {
        let response = `ðŸ“Š Ð¢Ð¾Ð¿-15 ÑÐ°Ð¼Ñ‹Ñ… Ñ‡Ð°ÑÑ‚Ñ‹Ñ… ÑÐ»Ð¾Ð² Ð·Ð° ${period === 'day' ? 'Ð´ÐµÐ½ÑŒ' : period === 'week' ? 'Ð½ÐµÐ´ÐµÐ»ÑŽ' : 'Ð¼ÐµÑÑÑ†'}:\n\n`;
        result.data.forEach(([word, count], index) => {
          response += `${index + 1}. "${word}" - ${count} Ñ€Ð°Ð·\n`;
        });

        await ctx.answerInlineQuery([
          {
            type: 'article',
            id: '1',
            title: 'ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹',
            description: `ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð¿-15 ÑÐ°Ð¼Ñ‹Ñ… Ñ‡Ð°ÑÑ‚Ñ‹Ñ… ÑÐ»Ð¾Ð² Ð·Ð° ${period === 'day' ? 'Ð´ÐµÐ½ÑŒ' : period === 'week' ? 'Ð½ÐµÐ´ÐµÐ»ÑŽ' : 'Ð¼ÐµÑÑÑ†'}`,
            input_message_content: {
              message_text: response
            }
          }
        ]);
      } else {
        await ctx.answerInlineQuery([
          {
            type: 'article',
            id: '1',
            title: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°',
            description: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚',
            input_message_content: {
              message_text: 'âŒ ' + result.error
            }
          }
        ]);
      }
    } else {
      await ctx.answerInlineQuery([
        {
          type: 'article',
          id: '1',
          title: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹',
          description: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°',
          input_message_content: {
            message_text: 'âŒ ' + messagesResult.error
          }
        }
      ]);
    }
  } else {
    await ctx.answerInlineQuery([
      {
        type: 'article',
        id: '1',
        title: 'ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð° Ð´ÐµÐ½ÑŒ',
        description: 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð¿-15 ÑÐ»Ð¾Ð² Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ°',
        input_message_content: {
          message_text: 'ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ°...'
        }
      },
      {
        type: 'article',
        id: '2',
        title: 'ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ',
        description: 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð¿-15 ÑÐ»Ð¾Ð² Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ',
        input_message_content: {
          message_text: 'ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ...'
        }
      },
      {
        type: 'article',
        id: '3',
        title: 'ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð° Ð¼ÐµÑÑÑ†',
        description: 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð¿-15 ÑÐ»Ð¾Ð² Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†',
        input_message_content: {
          message_text: 'ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†...'
        }
      }
    ]);
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.command('start', async (ctx) => {
  await ctx.reply(
    'ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð±Ð¾Ñ‚ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ñ‡Ð°Ñ‚Ðµ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¼ÐµÐ½Ñ Ð² Ð»ÑŽÐ±Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ:\n\n' +
    '1. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ @Ð¸Ð¼Ñ_Ð±Ð¾Ñ‚Ð°\n' +
    '2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° (Ð´ÐµÐ½ÑŒ, Ð½ÐµÐ´ÐµÐ»Ñ, Ð¼ÐµÑÑÑ†)\n' +
    '3. Ð¯ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾ÐºÐ°Ð¶Ñƒ Ñ‚Ð¾Ð¿-15 ÑÐ°Ð¼Ñ‹Ñ… Ñ‡Ð°ÑÑ‚Ñ‹Ñ… ÑÐ»Ð¾Ð²'
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.command('help', async (ctx) => {
  await ctx.reply(
    'ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°:\n\n' +
    '1. Ð’ Ð»ÑŽÐ±Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ @Ð¸Ð¼Ñ_Ð±Ð¾Ñ‚Ð°\n' +
    '2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n' +
    '   - Ð—Ð° Ð´ÐµÐ½ÑŒ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ°)\n' +
    '   - Ð—Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 7 Ð´Ð½ÐµÐ¹)\n' +
    '   - Ð—Ð° Ð¼ÐµÑÑÑ† (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 30 Ð´Ð½ÐµÐ¹)\n' +
    '3. Ð¯ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾ÐºÐ°Ð¶Ñƒ Ñ‚Ð¾Ð¿-15 ÑÐ°Ð¼Ñ‹Ñ… Ñ‡Ð°ÑÑ‚Ñ‹Ñ… ÑÐ»Ð¾Ð²\n\n' +
    'Ð’Ð°Ð¶Ð½Ð¾: Ð±Ð¾Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ñ‡Ð°Ñ‚Ð° Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹.'
  );
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.launch();

// Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM')); 